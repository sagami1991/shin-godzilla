{"version":3,"sources":["service/UserService.ts"],"names":[],"mappings":";AAGA;IAEC,qBAAoB,KAAmB;QAAnB,UAAK,GAAL,KAAK,CAAc;IACvC,CAAC;IAEM,6BAAO,GAAd,UAAe,EAAU;QACxB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,EAAC,GAAG,EAAE,EAAE,EAAC,CAAC,CAAC;IACxE,CAAC;IAED,gBAAgB;IAChB,cAAc;IACP,+BAAS,GAAhB;QACC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC;aAClD,IAAI,CAAC,EAAE,EAAE,EAAC,GAAG,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC,EAAC,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC;IAC1E,CAAC;IAEM,gCAAU,GAAjB,UAAkB,IAAgB;QAAlC,iBAKC;QAJA,MAAM,CAAC,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;YAClC,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,OAAO,EAAE,GAAG,MAAM,EAAE,CAAC;YAC3C,KAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,KAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC;QAChF,CAAC,CAAC,CAAC;IACJ,CAAC;IAEM,gCAAU,GAAjB,UAAkB,IAAgB;QAAlC,iBAKC;QAJA,MAAM,CAAC,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;YAClC,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,OAAO,EAAE,GAAG,MAAM,EAAE,CAAC;YAC3C,KAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,EAAC,GAAG,EAAE,IAAI,CAAC,GAAG,EAAC,EAAE,KAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC;QACjG,CAAC,CAAC,CAAC;IACJ,CAAC;IAEM,gCAAU,GAAjB,UAAkB,EAAU;QAC3B,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,SAAS,CAAC,EAAC,GAAG,EAAE,EAAE,EAAC,CAAC,CAAC;IACnE,CAAC;IAEO,oCAAc,GAAtB,UAAuB,IAAgB;QACtC,MAAM,CAAC;YACN,GAAG,EAAE,IAAI,CAAC,GAAG;YACb,EAAE,EAAE,IAAI,CAAC,EAAE;YACX,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,GAAG,EAAE,IAAI,CAAC,GAAG;YACb,IAAI,EAAE,IAAI,IAAI,EAAE;SAChB,CAAC;IACH,CAAC;IAEO,8BAAQ,GAAhB,UAAiB,IAAgB;QAChC,MAAM,CAAC,CACN,IAAI,CAAC,GAAG;YACR,IAAI,CAAC,IAAI;YACT,OAAO,IAAI,CAAC,EAAE,KAAK,QAAQ;YAC3B,OAAO,IAAI,CAAC,GAAG,KAAK,QAAQ,CAC3B,CAAC;IACJ,CAAC;IAlDc,kBAAM,GAAG,OAAO,CAAC;IAmDjC,kBAAC;AAAD,CApDA,AAoDC,IAAA;AApDY,mBAAW,cAoDvB,CAAA","file":"service/UserService.js","sourcesContent":["import {DbUserData, RankingInfo} from \"../share/share\";\r\nimport {MongoWrapper} from \"../server\";\r\n\r\nexport class UserService {\r\n\tprivate static C_NAME = \"users\";\r\n\tconstructor(private mongo: MongoWrapper) {\r\n\t}\r\n\r\n\tpublic getUser(id: string): Promise<DbUserData> {\r\n\t\treturn this.mongo.getCollection(UserService.C_NAME).findOne({_id: id});\r\n\t}\r\n\r\n\t// TODO インデックス貼る\r\n\t/** 上位数人を返す */\r\n\tpublic getRanker(): Promise<RankingInfo[]> {\r\n\t\treturn this.mongo.getCollection(UserService.C_NAME)\r\n\t\t.find({}, {_id: 0, lv: 1, name: 1}).limit(10).sort({ lv: -1 }).toArray();\r\n\t}\r\n\r\n\tpublic createUser(user: DbUserData) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.validate(user) ? resolve() : reject();\r\n\t\t\tthis.mongo.getCollection(UserService.C_NAME).insert(this.filterUserData(user));\r\n\t\t});\r\n\t}\r\n\r\n\tpublic updateUser(user: DbUserData) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.validate(user) ? resolve() : reject();\r\n\t\t\tthis.mongo.getCollection(UserService.C_NAME).update({_id: user._id}, this.filterUserData(user));\r\n\t\t});\r\n\t}\r\n\r\n\tpublic deleteUser(id: string) {\r\n\t\tthis.mongo.getCollection(UserService.C_NAME).deleteOne({_id: id});\r\n\t}\r\n\r\n\tprivate filterUserData(user: DbUserData): DbUserData {\r\n\t\treturn {\r\n\t\t\t_id: user._id,\r\n\t\t\tlv: user.lv,\r\n\t\t\tname: user.name,\r\n\t\t\texp: user.exp,\r\n\t\t\tdate: new Date()\r\n\t\t};\r\n\t}\r\n\r\n\tprivate validate(user: DbUserData) {\r\n\t\treturn (\r\n\t\t\tuser._id &&\r\n\t\t\tuser.name &&\r\n\t\t\ttypeof user.lv === \"number\" &&\r\n\t\t\ttypeof user.exp === \"number\"\r\n\t\t\t);\r\n\t}\r\n}"],"sourceRoot":"/source/"}