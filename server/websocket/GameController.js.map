{"version":3,"sources":["websocket/GameController.ts"],"names":[],"mappings":"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","file":"websocket/GameController.js","sourcesContent":["import * as WebSocket from 'ws';\r\nimport {WSWrapper} from \"./WebSocketWrapper\";\r\nimport {GodzillaController} from \"./GodzillaController\";\r\nimport {SocketType, InitialUserData, ReqEvilData, GameData, CONST, MasterEvilData} from \"../share/share\";\r\nimport {UserDataController} from \"./UserDataController\";\r\nimport {FieldController} from \"./FieldController\";\r\nimport {DiffExtract} from \"../share/util\";\r\nimport * as _ from \"lodash\";\r\nexport class GameController {\r\n\tpublic static FRAME = 30;\r\n\tprivate godzillaController: GodzillaController;\r\n\tprivate befSendData: GameData;\r\n\tprivate masterUsersData: MasterEvilData[] = [];\r\n\tprivate closeIds: string[] = [];\r\n\tpublic static getRandom<T>(arr: T[]): T  {\r\n\t\treturn arr ? arr[Math.floor(Math.random() * arr.length)] : null;\r\n\t}\r\n\tconstructor(private wsWrapper: WSWrapper,\r\n\t\t\t\tprivate userController: UserDataController) {\r\n\t\tthis.godzillaController = new GodzillaController(wsWrapper, this.masterUsersData);\r\n\t\tthis.godzillaController.init();\r\n\t}\r\n\r\n\tpublic init() {\r\n\t\tthis.wsWrapper.addMsgListner(SocketType.snapshot, (ws, reqData) => this.onReceiveSnapshot(ws, reqData));\r\n\t\tthis.wsWrapper.addMsgListner(SocketType.gozzilaDamege, (ws, reqData) => this.atkToGodzilla(ws, reqData));\t\r\n\t\tsetInterval(() => this.intervalAction(),  1000 / GameController.FRAME);\r\n\t\tthis.userController.onLvUp = (personId: string) => {\r\n\t\t\tconst evil = this.masterUsersData.find(evil => evil.pid === personId);\r\n\t\t\tif (evil) {\r\n\t\t\t\tevil.lv += 1;\r\n\t\t\t\tevil.isLvUp = true;\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.userController.onFirstConnect = (ws, user) => {\r\n\t\t\tconst userData: MasterEvilData = {\r\n\t\t\t\tisMigi: true,\r\n\t\t\t\tx: Math.round(Math.random() * 500),\r\n\t\t\t\ty: CONST.CANVAS.Y0,\r\n\t\t\t\tisAtk: false,\r\n\t\t\t\tisDead: false,\r\n\t\t\t\tpid: this.wsWrapper.getPersonId(ws),\r\n\t\t\t\tlv: user.lv,\r\n\t\t\t\tisLvUp: false,\r\n\t\t\t\tisHeal: false,\r\n\t\t\t\tname: user.name\r\n\t\t\t};\r\n\t\t\tthis.masterUsersData.push(userData);\r\n\r\n\t\t\tthis.wsWrapper.send(ws, SocketType.init, <InitialUserData> {\r\n\t\t\t\tpid: this.wsWrapper.getPersonId(ws),\r\n\t\t\t\tuser: Object.assign({}, user, userData),\r\n\t\t\t\tusers: this.masterUsersData,\r\n\t\t\t\tgozdilla: this.godzillaController.godzilla,\r\n\t\t\t\tbg: FieldController.bgType\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\tthis.userController.onClose = (ws) => {\r\n\t\t\tconst pid = this.wsWrapper.getPersonId(ws);\r\n\t\t\tthis.closeIds.push(pid);\r\n\t\t\t_.remove(this.masterUsersData, user => user.pid === pid);\r\n\t\t};\r\n\r\n\t\tthis.userController.onSave = (ws, user) => {\r\n\t\t\tconst userData = this.masterUsersData.find(user => user.pid === this.wsWrapper.getPersonId(ws));\r\n\t\t\tif (userData) userData.name = user.name;\r\n\t\t};\r\n\t}\r\n\r\n\tprivate atkToGodzilla(ws: WebSocket, damage: number) {\r\n\t\tthis.userController.increaseExp(ws);\r\n\t\tthis.godzillaController.damage(damage);\r\n\t}\r\n\r\n\tprivate intervalAction() {\r\n\t\tthis.godzillaController.roopAction();\r\n\t\tthis.sendSnapshot();\r\n\t}\r\n\r\n\tprivate sendSnapshot() {\r\n\t\tconst sendData: GameData = {\r\n\t\t\tgozzila: this.godzillaController.godzilla,\r\n\t\t\tevils: this.masterUsersData,\r\n\t\t\tcids: this.closeIds\r\n\t\t};\r\n\t\tconst snapShot = <GameData> DiffExtract.diff(this.befSendData, sendData);\r\n\t\tif (snapShot) {\r\n\t\t\tthis.wsWrapper.sendAll({\r\n\t\t\t\ttype: SocketType.snapshot,\r\n\t\t\t\tvalue: snapShot\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.masterUsersData.forEach(evil => evil.isLvUp = false);\r\n\t\tthis.closeIds = [];\r\n\t\tthis.befSendData = JSON.parse(JSON.stringify(sendData));\r\n\t}\r\n\r\n\t// MsgListner \r\n\tprivate onReceiveSnapshot(ws: WebSocket, reqData: ReqEvilData) {\r\n\t\tconst user = this.userController.getUser(ws);\r\n\t\tif (!user || !this.validateReqData(reqData)) {\r\n\t\t\tconsole.trace(\"不正なデータ\", reqData);\r\n\t\t\tws.close();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst evilInfo = this.masterUsersData.find(zahyou => zahyou.pid === this.wsWrapper.getPersonId(ws));\r\n\t\tif (evilInfo) {\r\n\t\t\t_.merge(evilInfo, this.filterEvilData(reqData));\r\n\t\t}\r\n\t}\r\n\r\n\tprivate filterEvilData(reqData: ReqEvilData): ReqEvilData {\r\n\t\treturn {\r\n\t\t\tisMigi: reqData.isMigi,\r\n\t\t\tx: reqData.x,\r\n\t\t\ty: reqData.y,\r\n\t\t\tisAtk: reqData.isAtk,\r\n\t\t\tisDead: reqData.isDead,\r\n\t\t\tisHeal: reqData.isHeal\r\n\t\t};\r\n\t}\r\n\r\n\tprivate validateReqData(reqData: ReqEvilData) {\r\n\t\treturn (\r\n\t\t\t[\"number\", \"undefined\"].includes(typeof reqData.x) &&\r\n\t\t\t(typeof reqData.y === \"undefined\" || (typeof reqData.y === \"number\" && reqData.y >= 150))\r\n\t\t);\r\n\t}\r\n}"],"sourceRoot":"/source/"}