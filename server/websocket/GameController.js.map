{"version":3,"sources":["websocket/GameController.ts"],"names":[],"mappings":"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","file":"websocket/GameController.js","sourcesContent":["import * as WebSocket from 'ws';\r\nimport {MainController, SocketType, ReqData} from \"./MainController\";\r\nimport {GodzillaController, GodzillaInfo} from \"./GodzillaController\";\r\n\r\ninterface GameData {\r\n\tgozzila: GodzillaInfo;\r\n\tevils: Zahyou[];\r\n}\r\nexport interface DbUserData {\r\n\t_id: string;\r\n\tlv: number;\r\n\tname: string;\r\n\texp: number;\r\n\tdate: Date;\r\n}\r\n\r\nexport interface Zahyou {\r\n\tpersonId: string;\r\n\tisMigiMuki: boolean;\r\n\tx: number;\r\n\ty: number;\r\n\tisAtk: boolean;\r\n\tisDead: boolean;\r\n\tlv: number;\r\n\tmaxExp: number;\r\n}\r\n\r\nexport class GameController {\r\n\tpublic static FRAME = 30;\r\n\tprivate godzillaController: GodzillaController;\r\n\tprivate befSendData: GameData;\r\n\tprivate evils: Zahyou[] = [];\r\n\tpublic static getRandom<T>(arr: T[]): T  {\r\n\t\treturn arr ? arr[Math.floor(Math.random() * arr.length)] : null;\r\n\t}\r\n\tconstructor(private main: MainController) {\r\n\t\tthis.godzillaController = new GodzillaController(main, this.evils);\r\n\t\tthis.godzillaController.init();\r\n\t}\r\n\r\n\tpublic init() {\r\n\t\tthis.main.addConnectListner(ws => this.onSomebodyConnect(ws));\r\n\t\tthis.main.addCloseListner(ws => this.deleteClosedEvil(ws));\r\n\t\tthis.main.addMsgListner({\r\n\t\t\ttype: SocketType.zahyou,\r\n\t\t\tcb: (ws, reqData) => this.updateEvils(ws, reqData)\r\n\t\t});\r\n\t\tsetInterval(() => this.intervalAction(), 1000 / GameController.FRAME);\r\n\t}\r\n\r\n\tprivate onSomebodyConnect(ws: WebSocket) {\r\n\t\tthis.main.sendAll({\r\n\t\t\tmyWs: ws,\r\n\t\t\tisSelfSend: false,\r\n\t\t\ttype: SocketType.infolog,\r\n\t\t\tvalue: `誰かがアクセスしました`\r\n\t\t});\r\n\t}\r\n\r\n\tprivate deleteClosedEvil(ws: WebSocket) {\r\n\t\tconst targetIdx = this.evils.findIndex(zahyou => zahyou.personId === this.main.getSercretKey(ws));\r\n\t\tthis.evils.splice(targetIdx, 1);\r\n\t}\r\n\r\n\tprivate intervalAction() {\r\n\t\tthis.godzillaController.roopAction();\r\n\t\tthis.sendGameData();\r\n\t}\r\n\r\n\tprivate sendGameData() {\r\n\t\tconst sendData = {\r\n\t\t\tgozzila: this.godzillaController.godzilla,\r\n\t\t\tevils: this.evils\r\n\t\t};\r\n\t\tif (JSON.stringify(this.befSendData) !== JSON.stringify(sendData)) {\r\n\t\t\tthis.main.sendAll({\r\n\t\t\t\ttype: SocketType.zahyou,\r\n\t\t\t\tvalue: sendData\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.befSendData = JSON.parse(JSON.stringify(sendData));\r\n\t}\r\n\r\n\tprivate updateEvils(nowWs: WebSocket, reqData: ReqData) {\r\n\t\tconst evilInfo = this.evils.find(zahyou => zahyou.personId === this.main.getSercretKey(nowWs));\r\n\t\tif (evilInfo) {\r\n\t\t\tObject.assign(evilInfo, reqData.value);\r\n\t\t} else {\r\n\t\t\tthis.evils.push(Object.assign({personId: this.main.getSercretKey(nowWs)}, reqData.value));\r\n\t\t}\r\n\t}\r\n}"],"sourceRoot":"/source/"}