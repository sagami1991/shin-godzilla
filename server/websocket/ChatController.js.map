{"version":3,"sources":["websocket/ChatController.ts"],"names":[],"mappings":";AAEA,+BAAkD,kBAAkB,CAAC,CAAA;AACrE;IACC,wBAAoB,IAAoB,EAAU,UAAsB;QAApD,SAAI,GAAJ,IAAI,CAAgB;QAAU,eAAU,GAAV,UAAU,CAAY;IACxE,CAAC;IAEM,6BAAI,GAAX;QAAA,iBAMC;QALA,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,UAAA,EAAE,IAAI,OAAA,KAAI,CAAC,WAAW,CAAC,EAAE,CAAC,EAApB,CAAoB,CAAC,CAAC;QACxD,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC;YACvB,IAAI,EAAE,2BAAU,CAAC,OAAO;YACxB,EAAE,EAAE,UAAC,EAAE,EAAE,OAAO,IAAK,OAAA,KAAI,CAAC,YAAY,CAAC,EAAE,EAAE,OAAO,CAAC,EAA9B,CAA8B;SACnD,CAAC,CAAC;IACJ,CAAC;IAEO,qCAAY,GAApB,UAAqB,EAAa,EAAE,OAAgB;QACnD,IAAM,OAAO,GAAG;YACf,GAAG,EAAE,OAAO,CAAC,KAAK;SAClB,CAAC;QACF,IAAI,CAAC;YACJ,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QACjC,CAAE;QAAA,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA,CAAC;QACd,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,EAAC,IAAI,EAAE,2BAAU,CAAC,OAAO,EAAE,KAAK,EAAE,OAAO,EAAC,CAAC,CAAC;IAC/D,CAAC;IAED;;OAEG;IACK,oCAAW,GAAnB,UAAoB,EAAa;QAChC,IAAI,CAAC,UAAU,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,EAAE,CAAC;aACrD,OAAO,CAAC,UAAC,GAAG,EAAE,GAAG;YACjB,EAAE,CAAC,CAAC,GAAG,CAAC;gBAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC1B,IAAI,CAAC;gBACJ,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC;oBACtB,IAAI,EAAE,2BAAU,CAAC,OAAO;oBACxB,KAAK,EAAE,GAAG,GAAG,GAAG,CAAC,OAAO,EAAE,GAAG,EAAE;iBAC/B,CAAC,CAAC,CAAC;YACL,CAAC;YAAA,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBAAA,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YAAC,CAAC;QAChC,CAAC,CAAC,CAAC;IACJ,CAAC;IACF,qBAAC;AAAD,CArCA,AAqCC,IAAA;AArCY,sBAAc,iBAqC1B,CAAA","file":"websocket/ChatController.js","sourcesContent":["import * as WebSocket from 'ws';\r\nimport {Collection} from 'mongodb';\r\nimport {MainController, SocketType, ReqData} from \"./MainController\";\r\nexport class ChatController {\r\n\tconstructor(private main: MainController, private collection: Collection) {\r\n\t}\r\n\r\n\tpublic init() {\r\n\t\tthis.main.addConnectListner(ws => this.sendInitLog(ws));\r\n\t\tthis.main.addMsgListner({\r\n\t\t\ttype: SocketType.chatLog,\r\n\t\t\tcb: (ws, reqData) => this.onReceiveMsg(ws, reqData)\r\n\t\t});\r\n\t}\r\n\r\n\tprivate onReceiveMsg(ws: WebSocket, reqData: ReqData) {\r\n\t\tconst chatMsg = {\r\n\t\t\tmsg: reqData.value,\r\n\t\t};\r\n\t\ttry {\r\n\t\t\tthis.collection.insert(chatMsg);\r\n\t\t} catch (e) {}\r\n\t\tthis.main.sendAll({type: SocketType.chatLog, value: chatMsg});\r\n\t}\r\n\r\n\t/**\r\n\t * DBから新しい順に数行分のログ取り出して送信\r\n\t */\r\n\tprivate sendInitLog(ws: WebSocket) {\r\n\t\tthis.collection.find().limit(7).sort({ $natural: -1 })\r\n\t\t.toArray((err, arr) => {\r\n\t\t\tif (err) console.log(err);\r\n\t\t\ttry {\r\n\t\t\t\tws.send(JSON.stringify({\r\n\t\t\t\t\ttype: SocketType.initlog,\r\n\t\t\t\t\tvalue: arr ? arr.reverse() : []\r\n\t\t\t\t}));\r\n\t\t\t}catch (e) {console.error(e); }\r\n\t\t});\r\n\t}\r\n}"],"sourceRoot":"/source/"}